# 🏗️ Новая архитектура приложения (двухэтапный процесс)

## 📋 Обзор

Приложение теперь работает в **двух независимых режимах**:

### **Режим 1: Переименование (watch_folder)**
- Автоматическое переименование видео файлов по встречам в Google Calendar
- Файл остается в `watch_folder` после переименования
- Пользователь вручную решает, нужна ли транскрипция

### **Режим 2: Транскрипция (to_transcribe_folder)**
- Пользователь вручную переносит файл в `to_transcribe_folder`
- Автоматически запускается загрузка на сервер транскрипции
- После загрузки файл перемещается в `output_folder`

---

## 📁 Структура папок

```
watch_folder/
├─ Video_2026-01-26_20-30-03.mp4          ← Исходный файл
└─ Front - Aorta weekly sync_2026-01-26_20-30-03.mp4  ← После переименования
   (Пользователь вручную переносит в to_transcribe_folder)

to_transcribe_folder/
├─ Front - Aorta weekly sync_2026-01-26_20-30-03.mp4  ← Пользователь переносит сюда
│  (Автоматически загружается на сервер)
└─ (Файл удаляется после загрузки)

output_folder/
├─ Front - Aorta weekly sync_2026-01-26_20-30-03.mp4  ← Файл перемещается сюда
│  (После успешной загрузки на сервер)
└─ (Остается здесь для архива)
```

---

## 🔄 Полный процесс

### **Этап 1: Мониторинг watch_folder (Переименование)**

```
1. Видео файл появляется в watch_folder
   └─ FileMonitor обнаруживает событие on_created
      └─ Вызывает on_video_created(file_path)

2. on_video_created() выполняет:
   ├─ Проверяет, готов ли файл (не пишется)
   ├─ Проверяет интернет
   ├─ Извлекает временную метку из имени файла
   ├─ Ищет встречу в Google Calendar
   │  ├─ Если встреч нет → показывает список всех встреч на дату
   │  ├─ Если 1 встреча → переименовывает автоматически
   │  └─ Если несколько → показывает список для выбора
   └─ Переименовывает файл по названию встречи
      └─ Формат: "{Meeting Title}_{YYYY-MM-DD}_{HH-MM-SS}.mp4"

3. handle_successful_rename() выполняет:
   ├─ Отправляет уведомление в Telegram
   │  └─ "✅ File renamed: {filename}"
   │  └─ "📝 Move it to the transcription folder to start transcription."
   └─ Файл остается в watch_folder
      └─ Пользователь вручную решает, нужна ли транскрипция
```

### **Этап 2: Мониторинг to_transcribe_folder (Транскрипция)**

```
1. Пользователь вручную переносит файл в to_transcribe_folder
   └─ FileMonitor обнаруживает событие on_created
      └─ Вызывает on_video_for_transcription(file_path)

2. on_video_for_transcription() выполняет:
   ├─ Проверяет, готов ли файл (не пишется)
   ├─ Проверяет интернет
   ├─ Извлекает информацию из имени файла
   │  ├─ Временная метка: {YYYY-MM-DD}_{HH-MM-SS}
   │  └─ Название встречи: все до временной метки
   ├─ Подготавливает meeting_info:
   │  ├─ meeting_name: название встречи
   │  ├─ meeting_time: время встречи
   │  └─ video_source_link: путь к файлу
   ├─ Отправляет уведомление в Telegram
   │  └─ "📤 Starting transcription for: {meeting_title}"
   └─ Загружает видео на сервер
      └─ uploader.upload_video(file_path, meeting_info)

3. _process_upload() выполняет:
   ├─ Отправляет POST запрос на сервер
   │  └─ POST /api/v1/transcription/upload-video
   ├─ Получает job_id
   ├─ Отправляет уведомление в Telegram
   │  └─ "📤 Uploaded: {filename}"
   ├─ Перемещает файл в output_folder
   │  └─ _move_file_to_output(file_path)
   │     └─ os.rename(file_path, output_folder/filename)
   └─ Запускает опрос статуса транскрипции
      └─ _poll_status(job_id, file_path)

4. После завершения транскрипции:
   ├─ Идентифицирует спикеров (AI)
   ├─ Предлагает пользователю редактировать спикеров
   ├─ Пользователь нажимает "Done"
   ├─ Финализирует транскрипт
   ├─ Загружает в Google Drive
   ├─ Добавляет строку в Google Sheets
   └─ Отправляет ссылку на Google Doc в Telegram
```

---

## ⚙️ Конфигурация

### Новые параметры в `config.json`:

```json
{
    "watch_folder": "C:/Path/To/Watch",
    "to_transcribe_folder": "C:/Path/To/ToTranscribe",
    "output_folder": "C:/Path/To/Output",
    "enable_upload": true,
    ...
}
```

### Описание папок:

| Папка | Назначение | Кто создает | Кто удаляет |
|-------|-----------|-----------|-----------|
| `watch_folder` | Исходные видео файлы | Пользователь/ОС | Пользователь |
| `to_transcribe_folder` | Файлы для транскрипции | Пользователь | Приложение (после загрузки) |
| `output_folder` | Архив обработанных файлов | Приложение | Пользователь |

---

## 🎯 Преимущества новой архитектуры

### ✅ Разделение ответственности
- **watch_folder**: только переименование
- **to_transcribe_folder**: только транскрипция
- Пользователь контролирует, какие файлы транскрибировать

### ✅ Гибкость
- Можно переименовать файл, но не транскрибировать его
- Можно отредактировать имя файла перед транскрипцией
- Можно обработать несколько файлов параллельно

### ✅ Безопасность
- Исходные файлы остаются в watch_folder
- Обработанные файлы архивируются в output_folder
- Легко отследить историю обработки

### ✅ Производительность
- Два независимых монитора работают параллельно
- Не блокируют друг друга
- Можно обрабатывать файлы в разном темпе

---

## 📊 Диаграмма потока

```
┌─────────────────────────────────────────────────────────────────┐
│                    ИНИЦИАЛИЗАЦИЯ                                │
│  Запуск двух мониторов: watch_folder и to_transcribe_folder    │
└────────────────────────┬────────────────────────────────────────┘
                         │
         ┌───────────────┴───────────────┐
         │                               │
         ▼                               ▼
┌──────────────────────┐      ┌──────────────────────┐
│  WATCH_FOLDER        │      │ TO_TRANSCRIBE_FOLDER │
│  (Переименование)    │      │  (Транскрипция)      │
└──────────────────────┘      └──────────────────────┘
         │                               │
         ▼                               ▼
┌──────────────────────┐      ┌──────────────────────┐
│ Видео файл           │      │ Пользователь         │
│ появляется           │      │ переносит файл       │
└──────────────────────┘      └──────────────────────┘
         │                               │
         ▼                               ▼
┌──────────────────────┐      ┌──────────────────────┐
│ Извлечение времени   │      │ Извлечение информации│
│ из имени файла       │      │ из имени файла       │
└──────────────────────┘      └──────────────────────┘
         │                               │
         ▼                               ▼
┌──────────────────────┐      ┌──────────────────────┐
│ Поиск встречи в      │      │ Загрузка на сервер   │
│ Google Calendar      │      │ транскрипции         │
└──────────────────────┘      └──────────────────────┘
         │                               │
         ▼                               ▼
┌──────────────────────┐      ┌──────────────────────┐
│ Переименование файла │      │ Перемещение в        │
│ по названию встречи  │      │ output_folder        │
└──────────────────────┘      └──────────────────────┘
         │                               │
         ▼                               ▼
┌──────────────────────┐      ┌──────────────────────┐
│ Файл остается в      │      │ Опрос статуса        │
│ watch_folder         │      │ транскрипции         │
└──────────────────────┘      └──────────────────────┘
         │                               │
         ▼                               ▼
┌──────────────────────┐      ┌──────────────────────┐
│ Уведомление в TG:    │      │ Идентификация        │
│ "File renamed"       │      │ спикеров (AI)        │
│ "Move to transcribe" │      │                      │
└──────────────────────┘      └──────────────────────┘
                                        │
                                        ▼
                              ┌──────────────────────┐
                              │ Редактирование       │
                              │ спикеров в TG        │
                              └──────────────────────┘
                                        │
                                        ▼
                              ┌──────────────────────┐
                              │ Финализация          │
                              │ Загрузка в Drive     │
                              │ Добавление в Sheets  │
                              └──────────────────────┘
```

---

## 🔧 Изменения в коде

### 1. Конфигурация (`config/config.py`)
- Добавлены параметры: `to_transcribe_folder`, `output_folder`
- Обновлена валидация конфигурации

### 2. Инициализация (`main.py`)
- Добавлен второй монитор: `self.transcribe_monitor`
- Оба монитора запускаются в методе `run()`

### 3. Обработка видео (`main.py`)
- `on_video_created()`: только переименование
- `on_video_for_transcription()`: только транскрипция
- `handle_successful_rename()`: просто уведомление, файл остается

### 4. Загрузка видео (`video_uploader.py`)
- Добавлен метод `_move_file_to_output()`
- Вызывается после успешной загрузки
- Перемещает файл из `to_transcribe_folder` в `output_folder`

---

## 📝 Примеры использования

### Сценарий 1: Переименование и транскрипция

```
1. Видео файл "Video_2026-01-26_20-30-03.mp4" появляется в watch_folder
2. Приложение переименовывает его в "Front - Aorta weekly sync_2026-01-26_20-30-03.mp4"
3. Пользователь видит уведомление в Telegram
4. Пользователь переносит файл в to_transcribe_folder
5. Приложение загружает файл на сервер
6. Приложение перемещает файл в output_folder
7. Приложение ждет завершения транскрипции
8. Пользователь редактирует спикеров в Telegram
9. Приложение финализирует и публикует результаты
```

### Сценарий 2: Только переименование (без транскрипции)

```
1. Видео файл появляется в watch_folder
2. Приложение переименовывает его
3. Пользователь видит уведомление в Telegram
4. Пользователь решает, что транскрипция не нужна
5. Файл остается в watch_folder
6. Пользователь может удалить его вручную
```

### Сценарий 3: Несколько файлов параллельно

```
1. Несколько видео файлов появляются в watch_folder
2. Приложение переименовывает их все параллельно
3. Пользователь переносит некоторые в to_transcribe_folder
4. Приложение загружает их параллельно
5. Приложение обрабатывает транскрипции независимо
```

---

## ⚠️ Важные замечания

### Имя файла в to_transcribe_folder

Файл **должен** быть переименован перед перемещением в `to_transcribe_folder`.

**Правильный формат:**
```
Front - Aorta weekly sync_2026-01-26_20-30-03.mp4
```

**Неправильный формат:**
```
Video_2026-01-26_20-30-03.mp4  ← Не содержит названия встречи
```

### Обработка ошибок

Если файл не может быть обработан:
- Приложение отправляет уведомление в Telegram
- Файл остается в папке
- Пользователь может исправить проблему и переместить файл снова

---

## 🚀 Запуск приложения

```bash
python main.py
```

Приложение выведет:
```
============================================================
Auto-Meeting Video Renamer is running...
============================================================
📁 Watch folder (renaming): D:\Nextcloud\Videos\ScreenRecordings\JustRecorded
📁 Transcribe folder: D:\Nextcloud\Videos\ToTranscribe
📁 Output folder: D:\Nextcloud\Videos\Transcribed
============================================================
Press Ctrl+C to exit
```

---

## 📚 Дополнительная информация

- Оба монитора работают независимо
- Можно отключить транскрипцию, установив `enable_upload: false`
- Файлы в `output_folder` - это архив обработанных видео
- Логи содержат префиксы `[WATCH_FOLDER]` и `[TO_TRANSCRIBE_FOLDER]` для удобства отладки
